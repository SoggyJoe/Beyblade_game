<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Beyblade Game Lobby</title>
  <style>
    body {
      background: #222; color: #ffeb3b; font-family: 'Roboto', sans-serif;
      display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0;
    }
    h1 { margin-top: 40px; font-size: 2.5rem; }
    .screen { display: none; flex-direction: column; align-items: center; width: 340px; background: #333; padding: 30px; border-radius: 14px; box-shadow: 0 0 20px #000; margin-top: 30px; }
    .active { display: flex; }
    .lobby-btn, .arrow-btn, .option-btn {
      font-size: 1.1rem; padding: 12px; border: none; border-radius: 7px; background: #ffeb3b; color: #222; cursor: pointer; font-weight: bold; transition: background 0.15s; margin-bottom: 16px;
    }
    .lobby-btn:hover, .arrow-btn:hover, .option-btn:hover { background: #fff176; }
    .arrow-btn { align-self: flex-start; margin-bottom: 20px; background: #ffe082; width: 44px; height: 44px; font-size: 1.5rem; display: flex; justify-content: center; align-items: center; border-radius: 50%; }
    .customize-form label, .customize-form select { margin: 7px 0; font-size: 1rem; color: #fffde7; }
    .customize-form select { width: 180px; padding: 5px; }
    .customize-form button[type="submit"] { margin-top: 18px; padding: 10px 28px; font-size: 16px; background: #28a745; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    #cheeseBtn { background: #ffe082; color: #d84315; border: 2px solid #ffd54f; font-weight: bold; margin: 10px 0 5px 0; display: none; animation: pop 0.4s; }
    .stats-table { margin-top: 15px; border-collapse: collapse; width: 100%; }
    .stats-table th, .stats-table td { border: 1px solid #aaa; padding: 5px 9px; text-align: center; }
    .stats-table th { background: #f3f3f3; color: #333; }
    .custom-save-msg { color: #c0ffb3; margin: 8px 0; display: none; font-weight: bold; }
    #fightModal {
      display: none; position: fixed; z-index: 2001; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7); align-items: center; justify-content: center;
    }
    .fight-modal-content {
      background: #222; color: #ffeb3b; border-radius: 14px; box-shadow: 0 0 36px #000b;
      padding: 32px 24px; max-width: 520px; width: 90vw; text-align: center; position: relative;
      min-height: 280px;
      min-width: 320px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .fight-close-btn {
      position: absolute; top: 14px; right: 14px; background: #f44336; color: #fff; border: none;
      border-radius: 5px; font-size: 15px; padding: 6px 16px; cursor: pointer;
    }
    .fight-dialogue-block {
      display: flex; align-items: flex-start; gap: 20px; min-height: 70px; margin-bottom: 10px; justify-content: center;
    }
    .fight-dialogue-face {
      width: 70px; height: 70px; background: #333; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-size: 60px; margin-top: 2px; margin-bottom: 4px; border: 3px solid #ffeb3b;
      overflow: hidden; flex-shrink: 0; position: relative;
    }
    .fight-dialogue-face img {
      width: 68px; height: 68px; border-radius: 50%; object-fit: cover; display: block; position: relative; z-index: 1;
    }
    .talking-mouth {
      position: absolute; left: 21px; top: 42px; width: 28px; height: 18px; background: #222;
      border-radius: 0 0 13px 13px/0 0 30px 30px; border-bottom: 3px solid #ffeb3b;
      animation: mouthOpen 0.45s infinite; z-index: 2;
    }
    .face-container {
      position: relative; width: 70px; height: 70px; display: inline-block; background: transparent;
    }
    .fight-dialogue-text { font-size: 1.1em; color: #fffde7; text-align: left; align-self: center; min-width: 170px; min-height: 54px; }
    .fight-result { font-size: 1.3em; margin: 22px 0 10px 0; }
    .battle-gif {
      max-width: 220px; max-height: 180px; margin: 18px auto 6px auto; display: block;
      border-radius: 12px; box-shadow: 0 0 16px #000a;
      background: #333;
    }
    .cheese-badge {
      background: #ffe082;
      color: #d84315;
      border-radius: 8px;
      font-size: 1.1em;
      padding: 6px 13px;
      font-weight: bold;
      border: 2px solid #ffd54f;
      margin: 8px 0;
      display: inline-block;
      vertical-align: middle;
      letter-spacing: 1px;
    }
    @keyframes pop {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    @keyframes mouthOpen {
      0%, 100% { clip-path: ellipse(30% 10% at 50% 70%); }
      50%      { clip-path: ellipse(30% 30% at 50% 80%); }
    }
    .secret-box {
      display: flex; flex-direction: column; background: #444; padding: 18px; border-radius: 8px; margin-top: 20px; align-items: center;
    }
    .secret-box input[type="text"] { padding: 8px; border-radius: 4px; border: 1px solid #888; font-size: 1.1rem; margin-bottom: 8px; width: 180px; text-align: center; }
    .cheese-result { background: #ffe082; color: #222; font-weight: bold; border-radius: 6px; padding: 12px; margin-top: 10px; display: none; animation: pop 0.5s; }
  </style>
</head>
<body>
  <h1>Beyblade Game Lobby</h1>
  <div id="lobbyScreen" class="screen active">
    <button class="lobby-btn" onclick="showScreen('customizeScreen')">Customize Your Beyblades</button>
    <button class="lobby-btn" onclick="startStoryMode()">Fight Story Mode</button>
    <button class="lobby-btn" onclick="startFriendFight()">Fight with a Friend</button>
  </div>
  <div id="customizeScreen" class="screen">
    <button class="arrow-btn" onclick="showScreen('lobbyScreen')" title="Back to Lobby">&#8592;</button>
    <h2>Customize Your Beyblade</h2>
    <button id="cheeseBtn" type="button" onclick="setCheeseBeyblade()">ðŸ§€ Cheese Beyblade</button>
    <form class="customize-form" id="customForm">
      <label for="layer">Layer (Attack Ring):</label>
      <select id="layer"></select>
      <label for="disk">Disk (Weight Disk/CWD):</label>
      <select id="disk"></select>
      <label for="driver">Driver (Running Core):</label>
      <select id="driver"></select>
      <button type="submit">Save Beyblade</button>
    </form>
    <div id="customSaveMsg" class="custom-save-msg">Beyblade saved!</div>
    <div id="stats"></div>
  </div>
  <div id="storyScreen" class="screen">
    <div id="storyContent"></div>
    <div id="storyOptions" style="margin-top:18px;"></div>
  </div>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Beyblade Game - HMS Story Mode</title>
  <style>
    body { background: #181c22; color: #f6f6f6; font-family: Arial, sans-serif; }
    h1, h2 { text-align: center; }
    .center { display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .section { margin: 30px auto; max-width: 700px; background: #22272e; padding: 22px; border-radius: 10px; box-shadow: 0 2px 12px #1118; }
    .hidden { display: none; }
    .stats-board { display: flex; justify-content: space-around; margin-top: 16px; }
    .stats { background: #242b33; border-radius: 7px; padding: 10px 18px; min-width: 180px;}
    .special-message { color: #FFD700; margin: 10px 0 0 0; font-weight: bold; text-align: center; }
    .battle-gif { display: block; margin: 0 auto; max-width: 100%; height: 220px; }
    button { background: #3b8beb; color: #fff; border: none; border-radius: 5px; padding: 12px 24px; font-size: 18px; margin-top: 18px; cursor: pointer; }
    button:hover { background: #26568d; }
    select, option { background: #191d23; color: #fff; }
    .versus { font-size: 21px; font-weight: bold; text-align: center; }
    pre { white-space: pre-line; }
  </style>
</head>
<body>
  <h1>Beyblade HMS Story Mode</h1>
  <div id="player-select-section" class="section center">
    <h2>Select Your Beyblade</h2>
    <select id="player-beyblade-select"></select>
    <button onclick="startStoryMode()">Start Story Mode</button>
  </div>

  <div id="battle-section" class="section center hidden">
    <h2>Battle <span id="battle-number"></span>: <span id="opponent-blader"></span></h2>
    <div class="versus"><span id="player-bey-name"></span> VS <span id="opponent-bey-name"></span></div>
    <img src="https://media.tenor.com/aM0RPAK-Kj0AAAAC/beyblade-burst-evolution-valt-aoi.gif" alt="Battle GIF" id="battle-gif" class="battle-gif">
  </div>

  <div id="result-section" class="section hidden">
    <h2 id="result-title"></h2>
    <div id="battle-summary"></div>
    <div class="stats-board">
      <div class="stats">
        <h3>Your Beyblade</h3>
        <div id="player-stats"></div>
      </div>
      <div class="stats">
        <h3>Opponent's Beyblade</h3>
        <div id="opponent-stats"></div>
      </div>
    </div>
    <div id="special-message" class="special-message"></div>
    <div class="center">
      <button id="next-btn" onclick="nextBattle()">Next Battle</button>
      <button id="restart-btn" class="hidden" onclick="location.reload()">Restart Story Mode</button>
    </div>
  </div>
  <script>
    // Player beys (including Cheese Beyblade)
    const beys = [
      { name: "Dranzer MS", attack: 8, defense: 6, stamina: 7, luck: 5 },
      { name: "Driger MS", attack: 7, defense: 9, stamina: 6, luck: 5 },
      { name: "Dragoon MS", attack: 9, defense: 4, stamina: 8, luck: 6 },
      { name: "Draciel MS", attack: 4, defense: 9, stamina: 8, luck: 5 },
      { name: "Wolborg MS", attack: 6, defense: 6, stamina: 10, luck: 6 },
      { name: "Advance Guardian", attack: 7, defense: 8, stamina: 7, luck: 6 },
      { name: "Death Gargoyle MS", attack: 8, defense: 5, stamina: 8, luck: 6 },
      { name: "Hopper Attack", attack: 8, defense: 5, stamina: 7, luck: 7 },
      { name: "Einstein MS", attack: 5, defense: 7, stamina: 9, luck: 8 },
      { name: "Cheese Beyblade", attack: 99, defense: 99, stamina: 99, luck: 99, cheese: true }
    ];

    // HMS anime story mode opponents (18)
    const npcs = [
      { blader: "Kai", bey: "Dranzer MS", attack: 8, defense: 6, stamina: 7, luck: 5 },
      { blader: "Ray", bey: "Driger MS", attack: 7, defense: 9, stamina: 6, luck: 5 },
      { blader: "Tyson", bey: "Dragoon MS", attack: 9, defense: 4, stamina: 8, luck: 6 },
      { blader: "Max", bey: "Draciel MS", attack: 4, defense: 9, stamina: 8, luck: 5 },
      { blader: "Tala", bey: "Wolborg MS", attack: 6, defense: 6, stamina: 10, luck: 6 },
      { blader: "Daichi", bey: "Gaia Dragoon MS", attack: 8, defense: 5, stamina: 8, luck: 7 },
      { blader: "Brooklyn", bey: "Zeus", attack: 8, defense: 7, stamina: 10, luck: 8 },
      { blader: "Garland", bey: "Apollo G", attack: 7, defense: 8, stamina: 8, luck: 7 },
      { blader: "Miguel", bey: "Dark Leopard MS", attack: 9, defense: 5, stamina: 7, luck: 6 },
      { blader: "Crusher", bey: "Gryphon Dragoon", attack: 8, defense: 8, stamina: 6, luck: 6 },
      { blader: "Ming-Ming", bey: "Venusian G", attack: 6, defense: 5, stamina: 9, luck: 8 },
      { blader: "Mystel", bey: "Poseidon G", attack: 6, defense: 5, stamina: 10, luck: 8 },
      { blader: "Rick", bey: "Wyvern DJ", attack: 8, defense: 7, stamina: 7, luck: 6 },
      { blader: "Lee", bey: "Galeon MS", attack: 7, defense: 8, stamina: 7, luck: 7 },
      { blader: "Julia", bey: "Thunder Dragon", attack: 8, defense: 6, stamina: 8, luck: 7 },
      { blader: "Salima", bey: "Cyber Driger", attack: 7, defense: 7, stamina: 8, luck: 7 },
      { blader: "King", bey: "Ariel 2", attack: 9, defense: 7, stamina: 8, luck: 8 },
      { blader: "Ozuma", bey: "Flash Leopard MS", attack: 8, defense: 8, stamina: 8, luck: 8 }
    ];

    // Populate beyblade select
    let playerBey;
    let playerBeyIndex = 0;
    let currentOpponent = 0;

    const select = document.getElementById('player-beyblade-select');
    beys.forEach((bey, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = bey.name;
      select.appendChild(opt);
    });

    select.addEventListener('change', function() {
      playerBeyIndex = Number(this.value);
    });

    function startStoryMode() {
      playerBey = beys[playerBeyIndex];
      currentOpponent = 0;
      document.getElementById('player-select-section').classList.add('hidden');
      startBattle();
    }

    function startBattle() {
      const npc = npcs[currentOpponent];
      document.getElementById('battle-section').classList.remove('hidden');
      document.getElementById('result-section').classList.add('hidden');

      document.getElementById('battle-number').textContent = (currentOpponent + 1);
      document.getElementById('opponent-blader').textContent = npc.blader;
      document.getElementById('player-bey-name').textContent = playerBey.name;
      document.getElementById('opponent-bey-name').textContent = npc.bey;

      // Play GIF, then show result after 3 seconds
      setTimeout(() => {
        showResult(npc);
      }, 3000);
    }

    function showResult(npc) {
      document.getElementById('battle-section').classList.add('hidden');
      document.getElementById('result-section').classList.remove('hidden');
      let summary = '';
      let specialMessage = '';

      // Cheese Beyblade instant win
      if (playerBey.cheese) {
        document.getElementById('result-title').textContent = "You Win!";
        summary = `As soon as you launched the Cheese Beyblade, ${npc.blader}'s ${npc.bey} shattered like it was made of fragile glass!`;
        specialMessage = "Legend says no beyblade can withstand the power of cheese.";
        renderStats(playerBey, npc);
        document.getElementById('battle-summary').textContent = summary;
        document.getElementById('special-message').textContent = specialMessage;
        document.getElementById('next-btn').classList.toggle('hidden', currentOpponent === npcs.length - 1);
        document.getElementById('restart-btn').classList.toggle('hidden', currentOpponent !== npcs.length - 1);
        return;
      }

      // Battle logic: Stat-based outcome
      // Randomly decide if KO or spin finish based on relative luck
      let totalLuck = playerBey.luck + npc.luck;
      let spinChance = playerBey.luck / totalLuck;
      let isSpin = Math.random() < spinChance;

      let playerScore = 0, npcScore = 0, outcomeType = '';

      if (isSpin) {
        // Spin finish: stamina matters most, then defense, then luck
        playerScore = playerBey.stamina * 2 + playerBey.defense + playerBey.luck + Math.floor(Math.random() * 5);
        npcScore = npc.stamina * 2 + npc.defense + npc.luck + Math.floor(Math.random() * 5);
        outcomeType = 'Spin Finish';
      } else {
        // KO: attack matters most, then defense, then luck
        playerScore = playerBey.attack * 2 + playerBey.defense + playerBey.luck + Math.floor(Math.random() * 5);
        npcScore = npc.attack * 2 + npc.defense + npc.luck + Math.floor(Math.random() * 5);
        outcomeType = 'KO';
      }

      // Add a small random variance for realism
      playerScore += Math.floor(Math.random() * 4) - 2;
      npcScore += Math.floor(Math.random() * 4) - 2;

      let didPlayerWin = playerScore >= npcScore;

      document.getElementById('result-title').textContent = didPlayerWin ? "You Win!" : "You Lose!";

      summary += `Battle Start!\n`;
      summary += `Your ${playerBey.name} vs ${npc.blader}'s ${npc.bey}\n`;
      summary += `Battle type: ${outcomeType}\n`;
      if (outcomeType === "Spin Finish") {
        summary += "Both beys spun fiercely, relying on their stamina and defense!\n";
      } else {
        summary += "Both beys clashed with powerful attacks, aiming for a ring-out!\n";
      }
      summary += `Your score: ${playerScore}\n`;
      summary += `${npc.blader}'s score: ${npcScore}\n`;
      summary += didPlayerWin
        ? `You defeated ${npc.blader}'s ${npc.bey} with a ${outcomeType}!`
        : `${npc.blader}'s ${npc.bey} defeated you with a ${outcomeType}...`;
      if (!didPlayerWin && Math.abs(playerScore - npcScore) < 4) {
        summary += "\nIt was a close match!";
      }
      document.getElementById('battle-summary').innerHTML = `<pre>${summary}</pre>`;
      document.getElementById('special-message').textContent = specialMessage;
      renderStats(playerBey, npc);

      // Show/hide next/restart buttons as needed
      document.getElementById('next-btn').classList.toggle('hidden', !didPlayerWin || currentOpponent === npcs.length - 1);
      document.getElementById('restart-btn').classList.toggle('hidden', didPlayerWin && currentOpponent !== npcs.length - 1);
      if (!didPlayerWin) {
        document.getElementById('next-btn').classList.add('hidden');
        document.getElementById('restart-btn').classList.remove('hidden');
      }
    }

    function renderStats(player, npc) {
      document.getElementById('player-stats').innerHTML =
        `Attack: ${player.attack}<br>
        Defense: ${player.defense}<br>
        Stamina: ${player.stamina}<br>
        Luck: ${player.luck}`;
      document.getElementById('opponent-stats').innerHTML =
        `Attack: ${npc.attack}<br>
        Defense: ${npc.defense}<br>
        Stamina: ${npc.stamina}<br>
        Luck: ${npc.luck}`;
    }

    function nextBattle() {
      currentOpponent++;
      if (currentOpponent < npcs.length) {
        startBattle();
      } else {
        document.getElementById('result-title').textContent = "Congratulations! You finished Story Mode!";
        document.getElementById('special-message').textContent = "You are the HMS Champion!";
        document.getElementById('next-btn').classList.add('hidden');
        document.getElementById('restart-btn').classList.remove('hidden');
      }
    }
  </script>
</body>
</html>
  <div id="fightModal">
    <div class="fight-modal-content">
      <button class="fight-close-btn" id="closeFightBtn">Close</button>
      <div id="modalDialogueBlock"></div>
      <div id="battleGifContainer" style="display:none;">
        <img src="https://tenor.com/view/beyblade-burst-evolution-valt-aoi-gif-24955798" alt="Beyblade Battle" class="battle-gif">
      </div>
      <div class="fight-result" id="fightResult" style="display:none;"></div>
    </div>
  </div>
  <div class="secret-box">
    <label for="secretInput">Enter Secret Code:</label>
    <input type="text" id="secretInput" placeholder="Secret Code">
    <button onclick="checkSecret()">Submit</button>
    <div class="cheese-result" id="cheeseResult">
      ðŸ§€ <strong>Cheese Beyblade Unlocked!</strong><br>
      Type: Cheese<br>
      Weight: <b>250 lbs</b><br>
      Spin Speed: <b>Mach 3.5</b><br>
      <span style="color:#d84315;font-weight:bold;">Any opponent beyblade shatters like glass!</span>
    </div>
  </div>
  <script>
    // --- HMS PARTS DATA ---
    const layers = {
      "Advance Striker":{attack:8,defense:4,stamina:5,weight:32},
      "Samurai Upper":{attack:7,defense:7,stamina:6,weight:33},
      "Wolborg MS":{attack:4,defense:5,stamina:9,weight:31},
      "Jiraiya Blade":{attack:9,defense:3,stamina:7,weight:32},
      "Slash Upper":{attack:7,defense:6,stamina:7,weight:32},
      "Magical Ape MS":{attack:6,defense:8,stamina:5,weight:33},
      "Phantom Fox MS":{attack:5,defense:6,stamina:7,weight:30},
      "Gaia Dragoon MS":{attack:10,defense:4,stamina:6,weight:31},
      "Sea Dragon":{attack:4,defense:9,stamina:5,weight:35},
      "Driger MS":{attack:6,defense:8,stamina:6,weight:31},
      "Dranzer MS":{attack:7,defense:5,stamina:8,weight:30},
      "Draciel MS":{attack:4,defense:10,stamina:4,weight:34},
      "Dragoon MS":{attack:9,defense:5,stamina:6,weight:29},
      "Dragoon MSUV":{attack:10,defense:6,stamina:5,weight:30},
      "CHEESE":{attack:99,defense:99,stamina:99,weight:250}
    };
    const disks = {
      "CWD Defense Ring":{attack:3,defense:9,stamina:8,weight:17},
      "CWD Free Survivor":{attack:6,defense:4,stamina:8,weight:16},
      "CWD God Ring":{attack:9,defense:5,stamina:4,weight:18},
      "CWD Reverse Defenser":{attack:2,defense:10,stamina:6,weight:19},
      "CWD Free Saucer":{attack:5,defense:5,stamina:9,weight:18},
      "CWD Attack Ring":{attack:10,defense:3,stamina:5,weight:17},
      "CWD Eternal Survivor":{attack:4,defense:6,stamina:10,weight:16},
      "CHEESE":{attack:99,defense:99,stamina:99,weight:0}
    };
    const drivers = {
      "Grip Flat Core":{attack:10,defense:2,stamina:2,weight:11},
      "Metal Sharp Core":{attack:2,defense:6,stamina:8,weight:12},
      "Bearing Core":{attack:1,defense:5,stamina:10,weight:13},
      "Metal Change Core":{attack:6,defense:7,stamina:5,weight:14},
      "Rubber Flat Core":{attack:9,defense:3,stamina:3,weight:10},
      "Metal Weight Core":{attack:3,defense:10,stamina:5,weight:15},
      "Customize Grip Core":{attack:7,defense:4,stamina:7,weight:13},
      "Metal Semi-Flat Core":{attack:5,defense:7,stamina:7,weight:12},
      "Bearing Core 2":{attack:2,defense:6,stamina:10,weight:13},
      "CHEESE":{attack:99,defense:99,stamina:99,weight:0}
    };
    let cheeseUnlocked = localStorage.getItem('cheeseUnlocked') === '1';
    function showCheeseBtn(){document.getElementById('cheeseBtn').style.display=cheeseUnlocked?'':'';}
    function populateDropdown(id,data,includeCheese=false){
      const select=document.getElementById(id);select.innerHTML='';
      for(let key in data){
        if(!includeCheese&&key==="CHEESE")continue;
        let option=document.createElement('option');option.value=key;option.text=key;select.appendChild(option);
      }
      if(includeCheese&&cheeseUnlocked){
        let option=document.createElement('option');option.value="CHEESE";option.text="ðŸ§€ CHEESE";select.appendChild(option);
      }
    }
    function updateStats(){
      const layer=document.getElementById('layer').value;
      const disk=document.getElementById('disk').value;
      const driver=document.getElementById('driver').value;
      let total;
      if(layer==="CHEESE"&&disk==="CHEESE"&&driver==="CHEESE"){total={attack:99,defense:99,stamina:99,weight:250};}
      else{total={attack:layers[layer].attack+disks[disk].attack+drivers[driver].attack,defense:layers[layer].defense+disks[disk].defense+drivers[driver].defense,stamina:layers[layer].stamina+disks[disk].stamina+drivers[driver].stamina,weight:layers[layer].weight+disks[disk].weight+drivers[driver].weight};}
      let extra="";if(layer==="CHEESE"&&disk==="CHEESE"&&driver==="CHEESE"){extra=`<span class="cheese-badge">CHEESE BEYBLADE<br>Weight: 250 lbs<br>Spin: Mach 3.5</span>`;}
      document.getElementById('stats').innerHTML=`
        <table class="stats-table">
          <tr><th>Part</th><th>Attack</th><th>Defense</th><th>Stamina</th><th>Weight</th></tr>
          <tr><td>${layer}</td><td>${layers[layer].attack}</td><td>${layers[layer].defense}</td><td>${layers[layer].stamina}</td><td>${layers[layer].weight}g</td></tr>
          <tr><td>${disk}</td><td>${disks[disk].attack}</td><td>${disks[disk].defense}</td><td>${disks[disk].stamina}</td><td>${disks[disk].weight}g</td></tr>
          <tr><td>${driver}</td><td>${drivers[driver].attack}</td><td>${drivers[driver].defense}</td><td>${drivers[driver].stamina}</td><td>${drivers[driver].weight}g</td></tr>
          <tr><th>Total</th><th>${total.attack}</th><th>${total.defense}</th><th>${total.stamina}</th><th>${total.weight}g</th></tr>
        </table>
        ${extra}`;
    }
    function saveCustomBeyblade(e){
      e.preventDefault();
      const layer=document.getElementById('layer').value;
      const disk=document.getElementById('disk').value;
      const driver=document.getElementById('driver').value;
      let stats;
      if(layer==="CHEESE"&&disk==="CHEESE"&&driver==="CHEESE"){stats={attack:99,defense:99,stamina:99,weight:250,cheese:true};}
      else{stats={attack:layers[layer].attack+disks[disk].attack+drivers[driver].attack,defense:layers[layer].defense+disks[disk].defense+drivers[driver].defense,stamina:layers[layer].stamina+disks[disk].stamina+drivers[driver].stamina,weight:layers[layer].weight+disks[disk].weight+drivers[driver].weight};}
      localStorage.setItem('customBeyblade',JSON.stringify({layer,disk,driver,stats}));
      document.getElementById('customSaveMsg').style.display='block';
      setTimeout(()=>{document.getElementById('customSaveMsg').style.display='none';},1200);
    }
    function setCheeseBeyblade(){document.getElementById('layer').value="CHEESE";document.getElementById('disk').value="CHEESE";document.getElementById('driver').value="CHEESE";updateStats();}
    function loadCustomBeyblade(){
      const data=JSON.parse(localStorage.getItem('customBeyblade'));
      if(data){document.getElementById('layer').value=data.layer;document.getElementById('disk').value=data.disk;document.getElementById('driver').value=data.driver;updateStats();}
    }
    function setupCustomization(){
      populateDropdown('layer',layers,cheeseUnlocked);
      populateDropdown('disk',disks,cheeseUnlocked);
      populateDropdown('driver',drivers,cheeseUnlocked);
      showCheeseBtn();
      updateStats();
      loadCustomBeyblade();
      document.getElementById('layer').onchange=updateStats;
      document.getElementById('disk').onchange=updateStats;
      document.getElementById('driver').onchange=updateStats;
      document.getElementById('customForm').onsubmit=saveCustomBeyblade;
    }
    document.addEventListener('DOMContentLoaded',function(){setupCustomization();});
    function showScreen(screenId){
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      if(screenId==='customizeScreen'){setupCustomization();}
    }
    // --- STORY MODE ---
    const storyFights=[
      {name:"Kai",faceImg:"images/kai.png",bey:"Dranzer MS",stats:{attack:13,defense:10,stamina:13,weight:60},line:"Let's see what you've got!"},
      {name:"Ray",faceImg:"images/ray.png",bey:"Driger MS",stats:{attack:12,defense:11,stamina:11,weight:62},line:"I'm not going easy on you!"},
      {name:"Brooklyn",faceImg:"images/brooklyn.png",bey:"Zeus",stats:{attack:16,defense:13,stamina:17,weight:63},line:"Can you keep up with me?"}
    ];
    let currentFight=0, fightEnded=false;
    function startStoryMode(){currentFight=0;showScreen('storyScreen');renderStoryFight();}
    function renderStoryFight(){
      const storyContent=document.getElementById('storyContent');
      const storyOptions=document.getElementById('storyOptions');
      if(currentFight<storyFights.length){
        const fight=storyFights[currentFight];
        storyContent.innerHTML=`<h2>Fight ${currentFight+1}: ${fight.name}</h2><p>Opponent Beyblade: <b>${fight.bey}</b></p>`;
        storyOptions.innerHTML=`<button class="option-btn" onclick="launchStoryFight()">Begin Fight</button>${currentFight>0?'<button class="option-btn" onclick="returnToLobby()">Back to Lobby</button>':''}`;
      }else{
        storyContent.innerHTML=`<h2>Congratulations!</h2><p>You defeated all opponents in Story Mode!</p>`;
        storyOptions.innerHTML=`<button class="option-btn" onclick="returnToLobby()">Back to Lobby</button><button class="option-btn" onclick="restartStory()">Fight Again</button>`;
      }
    }
    function restartStory(){currentFight=0;renderStoryFight();}
    function returnToLobby(){showScreen('lobbyScreen');}
    function launchStoryFight(){
      const custom=JSON.parse(localStorage.getItem('customBeyblade'));
      if(!custom){alert('Please customize your Beyblade first!');returnToLobby();return;}
      const fight=storyFights[currentFight];
      openFightModal(fight,custom,true);
    }
    // --- FRIEND FIGHT ---
    function startFriendFight(){
      const custom=JSON.parse(localStorage.getItem('customBeyblade'));
      if(!custom)return alert('Please customize your Beyblade first!');
      const rivalOptions=[{name:"Random Blader",faceImg:"images/rival1.png",bey:"Wolborg MS",stats:{attack:10,defense:10,stamina:10,weight:60},line:"Let's have a great match!"},{name:"Random Blader 2",faceImg:"images/rival2.png",bey:"Draciel MS",stats:{attack:8,defense:14,stamina:9,weight:62},line:"Give it your best shot!"}];
      const rival=rivalOptions[Math.floor(Math.random()*rivalOptions.length)];
      openFightModal(rival,custom,false);
    }
    // --- FIGHT MODAL LOGIC ---
    function openFightModal(rival,player,isStory){
      const modal=document.getElementById('fightModal');
      const dialogueBlock=document.getElementById('modalDialogueBlock');
      const resultDiv=document.getElementById('fightResult');
      const gifDiv=document.getElementById('battleGifContainer');
      document.getElementById('closeFightBtn').onclick=()=>{
        modal.style.display='none';dialogueBlock.innerHTML="";resultDiv.style.display='none';gifDiv.style.display='none';
        if(isStory&&fightEnded){currentFight++;renderStoryFight();}
      };
      fightEnded=false;modal.style.display='flex';dialogueBlock.innerHTML="";resultDiv.style.display='none';gifDiv.style.display='none';
      renderTalkingDialogue(rival.faceImg,rival.name,rival.line||"Let's battle!",function(){
        dialogueBlock.innerHTML+=`<div style="margin-top:12px;"><button class="option-btn" id="launchBtn">Launch Beyblades!</button></div>`;
        document.getElementById('launchBtn').onclick=()=>{
          // 1. Show GIF, hide dialogue and result
          dialogueBlock.innerHTML="";
          resultDiv.style.display='none';
          gifDiv.style.display='block';
          // 2. After a delay, hide GIF and show result
          setTimeout(()=>{
            gifDiv.style.display='none';
            // Your fight result logic:
            const usedCheese=player.layer==="CHEESE"&&player.disk==="CHEESE"&&player.driver==="CHEESE";
            let playerWin=false,KOed=null;
            if(usedCheese){playerWin=true;}
            else{
              // Simple fight logic: sum stats, add randomness
              const playerPower=player.stats.attack+player.stats.defense+player.stats.stamina+player.stats.weight+Math.random()*4;
              const rivalPower=rival.stats.attack+rival.stats.defense+rival.stats.stamina+rival.stats.weight+Math.random()*4;
              if(playerPower>rivalPower){playerWin=true;}
              KOed=null; // Could add KO logic if desired
            }
            showFightResult(player,rival,resultDiv,isStory,usedCheese,playerWin,KOed);
          }, 2500); // 2.5 seconds of GIF
        };
      });
    }
    function renderTalkingDialogue(faceImg,charName,text,onDone){
      const dialogueBlock=document.getElementById('modalDialogueBlock');
      dialogueBlock.innerHTML=`<div class="fight-dialogue-block"><span class="face-container"><span class="fight-dialogue-face" id="charFace"><img src="${faceImg}" alt="${charName}"><span class="talking-mouth"></span></span></span><span class="fight-dialogue-text" id="talkText"></span></div>`;
      let i=0;const speed=32;const talkText=document.getElementById('talkText');
      function typeLoop(){
        if(i<=text.length){
          talkText.innerHTML=`<b>${charName}:</b> "`+text.slice(0,i)+(i<text.length?'<span style="opacity:0.3;">'+text.slice(i,i+1)+'</span>':'')+'"';
          i++;setTimeout(typeLoop,speed+(Math.random()*35));
        }else{setTimeout(()=>{document.getElementById('charFace').querySelector('.talking-mouth').style.animation='none';if(onDone)onDone();},400);}
      }typeLoop();
    }
    function showFightResult(player,rival,resultDiv,isStory,usedCheese,playerWin,KOed){
      let resultMsg="";
      if(usedCheese){
        resultMsg=`<b>You win!</b><br>Your Cheese Beyblade shattered the opponent's beyblade into pieces!<br><span class="cheese-badge">UNSTOPPABLE CHEESE</span>`;
      }
      else if(playerWin){
        if(KOed&&KOed!==player){resultMsg=`<b>You win by K.O.!</b><br>You knocked your opponent out of the arena!`;}
        else{resultMsg=`<b>You win!</b><br>Your Beyblade was last spinning in the arena!`;}
      }else{
        if(KOed&&KOed!==rival){resultMsg=`<b>You lose by K.O.!</b><br>Your Beyblade was knocked out of the arena!`;}
        else{resultMsg=`<b>You lose!</b><br>${rival.name}'s Beyblade was last spinning in the arena.`;}
      }
      resultDiv.innerHTML=resultMsg;resultDiv.style.display='';fightEnded=true;
    }
    function checkSecret(){
      const input=document.getElementById('secretInput').value.trim();
      const result=document.getElementById('cheeseResult');
      if(input==="ILOVECH33S3"){
        result.style.display='block';cheeseUnlocked=true;localStorage.setItem('cheeseUnlocked','1');
        showCheeseBtn();populateDropdown('layer',layers,true);populateDropdown('disk',disks,true);populateDropdown('driver',drivers,true);updateStats();
      }else{
        result.style.display='none';cheeseUnlocked=false;localStorage.setItem('cheeseUnlocked','0');showCheeseBtn();alert("Incorrect code! Try again.");
      }
    }
  </script>
</body>
</html>
