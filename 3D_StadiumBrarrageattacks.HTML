<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Beyblade 3D Barrage Attack Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body { background: #23272e; color: #eee; font-family: sans-serif; text-align: center; }
        #stadium3d { margin: 30px auto; display: block; width: 600px; height: 400px; }
        .button { margin: 15px; padding: 10px 22px; font-size: 1.2em; border: none; border-radius: 7px; background: #2d8cf0; color: #fff; cursor: pointer; }
        .stats { margin-bottom: 12px; }
    </style>
</head>
<body>
    <h2>Beyblade 3D Barrage Attack Demo</h2>
    <div class="stats" id="stats">
        Red Health: <span id="health1">100</span> &nbsp;|&nbsp;
        Blue Health: <span id="health2">100</span>
    </div>
    <button class="button" id="attackBtn">Attack!</button>
    <div id="stadium3d"></div>
    <div id="log"></div>
    <script>
        // === SETUP 3D STADIUM & BEYBLADES ===
        const WIDTH = 600, HEIGHT = 400;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, WIDTH/HEIGHT, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
        renderer.setSize(WIDTH, HEIGHT);
        document.getElementById('stadium3d').appendChild(renderer.domElement);

        // Lighting
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const point = new THREE.PointLight(0xffffff, 1.5);
        point.position.set(0, 12, 10);
        scene.add(point);

        // Stadium (keep this, or import a model if you have one)
        const stadiumGeo = new THREE.CylinderGeometry(5.2, 5.2, 1, 80, 1, false);
        const stadiumMat = new THREE.MeshPhysicalMaterial({
            color: 0x888888,
            metalness: 0.2,
            roughness: 0.35,
            clearcoat: 0.7,
            clearcoatRoughness: 0.1
        });
        const stadium = new THREE.Mesh(stadiumGeo, stadiumMat);
        stadium.position.y = 0;
        stadium.receiveShadow = true;
        scene.add(stadium);

        // Camera position (immersive)
        let camOrbitAngle = Math.PI/3;
        function updateCamera() {
            camOrbitAngle += 0.0025;
            const radius = 10, y = 2.5;
            camera.position.set(
                Math.sin(camOrbitAngle) * radius,
                y,
                Math.cos(camOrbitAngle) * radius
            );
            camera.lookAt(0, 0.6, 0);
        }
        camera.position.set(0, 2.5, 10);

        // === IMPORTED BEYBLADE MODELS ===
        let bey1, bey2;
        const loader = new THREE.GLTFLoader();
        // Load both Beyblades
        loader.load('beyblade.glb', function(gltf) {
            bey1 = gltf.scene.clone(true);
            bey1.position.set(-2, 0.6, 0);
            bey1.scale.set(1.2, 1.2, 1.2);
            scene.add(bey1);

            bey2 = gltf.scene.clone(true);
            bey2.position.set(2, 0.6, 0);
            bey2.scale.set(1.2, 1.2, 1.2);
            scene.add(bey2);
        }, undefined, function(error) {
            document.getElementById('log').textContent = "Error loading beyblade.glb: " + error;
        });

        // === GAME LOGIC ===
        let player1 = { name: "Red", health: 100, attack: 10 };
        let player2 = { name: "Blue", health: 100, attack: 10 };

        function updateStats() {
            document.getElementById('health1').textContent = Math.max(0, Math.round(player1.health));
            document.getElementById('health2').textContent = Math.max(0, Math.round(player2.health));
        }
        function logMsg(msg) {
            document.getElementById('log').textContent = msg;
        }

        // === BARRAGE ANIMATION ===
        let barrageActive = false, barrageData = null;
        function performBarrageAttack(attacker, defender, attackerMesh, defenderMesh, onDone) {
            barrageActive = true;
            barrageData = {
                attacker, defender, attackerMesh, defenderMesh, onDone,
                hits: Math.floor(Math.random()*4)+2,
                step: 0, dir: 1, animPhase: 0, damage: 0,
            };
            logMsg(attacker.name + ' launches a BARRAGE ATTACK!');
        }
        function animateBarrage() {
            if (!barrageActive || !barrageData || !barrageData.attackerMesh || !barrageData.defenderMesh) return;
            const bd = barrageData;
            let t = Math.sin((bd.animPhase%20)/20*Math.PI);
            bd.attackerMesh.position.x = THREE.MathUtils.lerp(bd.attacker === player1 ? -2 : 2, 0, t*bd.dir);
            bd.animPhase++;
            if (bd.attackerMesh.children[0] && bd.attackerMesh.children[0].material) {
                // Flash effect if supported
                bd.attackerMesh.children[0].material.emissive = new THREE.Color(0xffff00);
                setTimeout(()=>{bd.attackerMesh.children[0].material.emissive = new THREE.Color(0x000000)}, 100);
            }
            if (bd.animPhase >= 20) {
                let hitDmg = bd.attacker.attack * (0.5 + Math.random());
                bd.defender.health -= hitDmg;
                bd.damage += hitDmg;
                updateStats();
                bd.dir *= -1;
                bd.animPhase = 0;
                bd.hits--;
                if (bd.hits <= 0) {
                    barrageActive = false;
                    bd.attackerMesh.position.x = bd.attacker === player1 ? -2 : 2;
                    logMsg(bd.attacker.name + ' finished barrage! Total damage: ' + Math.round(bd.damage));
                    if (bd.onDone) bd.onDone();
                }
            }
        }

        // === FIGHT SEQUENCE ===
        function startFight() {
            document.getElementById('attackBtn').disabled = true;
            if (!bey1 || !bey2) {
                logMsg("Beyblades are still loading. Please wait...");
                document.getElementById('attackBtn').disabled = false;
                return;
            }
            if (Math.random() < 0.4) {
                performBarrageAttack(player1, player2, bey1, bey2, fightResult);
            } else {
                player2.health -= player1.attack;
                updateStats();
                logMsg(player1.name + ' does a normal attack!');
                setTimeout(fightResult, 700);
            }
        }
        function fightResult() {
            if (player2.health <= 0) {
                logMsg('Blue is knocked out! Red wins!');
                document.getElementById('attackBtn').disabled = true;
                return;
            }
            setTimeout(()=>{
                if (Math.random() < 0.4) {
                    performBarrageAttack(player2, player1, bey2, bey1, ()=>{
                        if (player1.health <= 0) {
                            logMsg('Red is knocked out! Blue wins!');
                            document.getElementById('attackBtn').disabled = true;
                        } else {
                            document.getElementById('attackBtn').disabled = false;
                        }
                        updateStats();
                    });
                } else {
                    player1.health -= player2.attack;
                    updateStats();
                    logMsg('Blue does a normal attack!');
                    setTimeout(()=>{
                        if (player1.health <= 0) {
                            logMsg('Red is knocked out! Blue wins!');
                            document.getElementById('attackBtn').disabled = true;
                        } else {
                            document.getElementById('attackBtn').disabled = false;
                        }
                    }, 700);
                }
            }, 700);
        }

        document.getElementById('attackBtn').onclick = startFight;

        // === MAIN ANIMATION LOOP ===
        function animate() {
            requestAnimationFrame(animate);
            if (bey1) bey1.rotation.y += 0.17;
            if (bey2) bey2.rotation.y += 0.17;
            animateBarrage();
            updateCamera();
            renderer.render(scene, camera);
        }
        animate();

        // Init
        updateStats();
        logMsg('Press "Attack!" to start!');
    </script>
</body>
</html>
